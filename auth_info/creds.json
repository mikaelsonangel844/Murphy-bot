const fs = require('fs');
const path = require('path');

const authDir = path.join(__dirname, 'auth_info');
const authPath = path.join(authDir, 'creds.json');

// Fonction pour sauvegarder la session
function saveSession(session) {
    try {
        // Vérifier si le dossier 'auth_info' existe, sinon le créer
        if (!fs.existsSync(authDir)) {
            fs.mkdirSync(authDir, { recursive: true });
        }

        // Sauvegarde de la session dans le fichier creds.json
        fs.writeFileSync(authPath, JSON.stringify(session, null, 2));
        console.log("✅ Session sauvegardée !");
    } catch (error) {
        console.error("❌ Erreur lors de la sauvegarde de la session :", error);
    }
}

// Écoute des mises à jour de connexion
client.on('connection.update', async (update) => {
    const { connection, lastDisconnect } = update;

    if (connection === 'open') {
        const session = client.authState?.creds;
        if (session) {
            saveSession(session);
        } else {
            console.warn("⚠️ Aucune session valide trouvée !");
        }
    }
});
